{{ config(
    materialized='table'
) }}

WITH USER_LEAST_FAVORITE_TEAM AS 
(
SELECT 
    USERNAME,
    CUSTOMER_ID,
    CASE 
        WHEN SELECTION_NAME = TEAM_A THEN TEAM_B 
        WHEN SELECTION_NAME = TEAM_B THEN TEAM_A 
        WHEN SELECTION_NAME = 'Draw' THEN 'toto'
    END                                                 AS LEAST_FAVORITE_TEAM 
FROM {{ ref('retro_customer_bet_selection') }}
WHERE 
    MARKET_NAME = 'Match Result'
    AND LEAST_FAVORITE_TEAM != 'toto'
)

, RETRO_LEAST_FAVORITE_TEAM AS (
SELECT 
    USERNAME,
    CUSTOMER_ID,
    LEAST_FAVORITE_TEAM,
    COUNT(*) AS NB_BET_LEAST_FAVORITE_TEAM
FROM USER_LEAST_FAVORITE_TEAM 
GROUP BY 
    USERNAME,
    CUSTOMER_ID,
    LEAST_FAVORITE_TEAM
)

, TEAM_LIST AS (
SELECT 
  CUSTOMER_ID,
  USERNAME,
  LEAST_FAVORITE_TEAM AS TEAM,
  NB_BET_LEAST_FAVORITE_TEAM AS NB_BETS,
  row_number() over (partition by USERNAME order by NB_BETS DESC) as row_num
FROM RETRO_LEAST_FAVORITE_TEAM
qualify row_num <= 5
)

SELECT 
   USERNAME AS USER_NAME,
   CUSTOMER_ID,
   MAX(CASE WHEN ROW_NUM = 1 THEN TEAM ELSE NULL END) AS LEAST_FAVORITE_TEAM_1 ,
   MAX(CASE WHEN ROW_NUM = 1 THEN NB_BETS ELSE NULL END) AS NB_BET_LEAST_FAVORITE_TEAM_1 
FROM TEAM_LIST
GROUP BY 1, 2