{{ config(
    materialized='table'
) }}


  
WITH CUSTOMER_BETS AS (
    SELECT DISTINCT
    CUSTOMER_ID
    , USERNAME
    , BET_DATE::DATE AS BET_DATE
    , WINNING_AMOUNT
    , NB_SELECTION
FROM {{ ref('retro_customer_bet_selection') }}
)
  
, BIGGEST_WINS AS (
SELECT 
  CUSTOMER_ID
  , USERNAME
  , BET_DATE::DATE AS BET_DATE
  , WINNING_AMOUNT
  , NB_SELECTION
  , row_number() over (partition by USERNAME order by WINNING_AMOUNT DESC) as row_num
FROM CUSTOMER_BETS
  
qualify row_num <= 5
)
  
SELECT 
   USERNAME AS USER_NAME,
   CUSTOMER_ID,
   MAX(CASE WHEN ROW_NUM = 1 AND WINNING_AMOUNT != 0 THEN WINNING_AMOUNT ELSE NULL END) AS BIGGEST_WIN_1 ,
   MAX(CASE WHEN ROW_NUM = 2 AND WINNING_AMOUNT != 0 THEN WINNING_AMOUNT ELSE NULL END) AS BIGGEST_WIN_2 ,
   MAX(CASE WHEN ROW_NUM = 3 AND WINNING_AMOUNT != 0 THEN WINNING_AMOUNT ELSE NULL END) AS BIGGEST_WIN_3 ,
   MAX(CASE WHEN ROW_NUM = 4 AND WINNING_AMOUNT != 0 THEN WINNING_AMOUNT ELSE NULL END) AS BIGGEST_WIN_4 ,
   MAX(CASE WHEN ROW_NUM = 5 AND WINNING_AMOUNT != 0 THEN WINNING_AMOUNT ELSE NULL END) AS BIGGEST_WIN_5 ,
   
   MAX(CASE WHEN ROW_NUM = 1 AND WINNING_AMOUNT != 0 THEN BET_DATE ELSE NULL END) AS DATE_BIGGEST_WIN_1 ,
   MAX(CASE WHEN ROW_NUM = 2 AND WINNING_AMOUNT != 0 THEN BET_DATE ELSE NULL END) AS DATE_BIGGEST_WIN_2 ,
   MAX(CASE WHEN ROW_NUM = 3 AND WINNING_AMOUNT != 0 THEN BET_DATE ELSE NULL END) AS DATE_BIGGEST_WIN_3 ,
   MAX(CASE WHEN ROW_NUM = 4 AND WINNING_AMOUNT != 0 THEN BET_DATE ELSE NULL END) AS DATE_BIGGEST_WIN_4 ,
   MAX(CASE WHEN ROW_NUM = 5 AND WINNING_AMOUNT != 0 THEN BET_DATE ELSE NULL END) AS DATE_BIGGEST_WIN_5 ,

   MAX(CASE WHEN ROW_NUM = 1 AND WINNING_AMOUNT != 0 THEN NB_SELECTION ELSE NULL END) AS NB_SELECTION_BIGGEST_WIN_1 ,
   MAX(CASE WHEN ROW_NUM = 2 AND WINNING_AMOUNT != 0 THEN NB_SELECTION ELSE NULL END) AS NB_SELECTION_BIGGEST_WIN_2 ,
   MAX(CASE WHEN ROW_NUM = 3 AND WINNING_AMOUNT != 0 THEN NB_SELECTION ELSE NULL END) AS NB_SELECTION_BIGGEST_WIN_3 ,
   MAX(CASE WHEN ROW_NUM = 4 AND WINNING_AMOUNT != 0 THEN NB_SELECTION ELSE NULL END) AS NB_SELECTION_BIGGEST_WIN_4 ,
   MAX(CASE WHEN ROW_NUM = 5 AND WINNING_AMOUNT != 0 THEN NB_SELECTION ELSE NULL END) AS NB_SELECTION_BIGGEST_WIN_5 
FROM BIGGEST_WINS
GROUP BY 1, 2