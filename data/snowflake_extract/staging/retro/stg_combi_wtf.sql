{{ config(
    materialized='table'
) }}

WITH COMBIS AS (
SELECT 
    USERNAME,
    CUSTOMER_ID,
    BET_ID,
    BET_DATE::DATE AS BET_DATE,
    NB_SELECTION,
    SUM(CASE WHEN HAS_WON THEN 1 ELSE 0 END) AS NB_WON
FROM {{ ref('retro_customer_bet_selection') }} 
GROUP BY USERNAME, CUSTOMER_ID, BET_ID, BET_DATE::DATE, NB_SELECTION
HAVING 
    NB_SELECTION - NB_WON != 0 
    AND NB_SELECTION > 1 
)
, BIGGEST_COMBIS AS (
SELECT 
    USERNAME,
    CUSTOMER_ID,
    BET_ID,
    BET_DATE,
    NB_SELECTION,
    (100*NB_WON / NB_SELECTION )::NUMBER(38,0) AS WIN_RATE,
    row_number() over (partition by USERNAME order by NB_SELECTION, WIN_RATE DESC) as row_num
FROM COMBIS
qualify row_num <= 5
)
  
SELECT 
   USERNAME AS USER_NAME,
   CUSTOMER_ID,
   MAX(CASE WHEN ROW_NUM = 1 THEN WIN_RATE ELSE NULL END)::NUMBER(38,0) AS BIGGEST_NB_SELECTION_WIN_RATE_1 ,
   
   MAX(CASE WHEN ROW_NUM = 1 THEN NB_SELECTION ELSE NULL END) AS BIGGEST_NB_SELECTION_1 ,

   MAX(CASE WHEN ROW_NUM = 1 THEN BET_DATE ELSE NULL END) AS BIGGEST_NB_SELECTION_DATE_1 
FROM BIGGEST_COMBIS
GROUP BY 1, 2
