{{ config(
    materialized='table'
) }}

WITH ALL_DAYS AS (
SELECT 
    USERNAME,
    CUSTOMER_ID,
    BET_DATE::DATE AS BET_DATE,
    SUM(WINNING_AMOUNT) AS WINNING_AMOUNT,
    SUM(CASE WHEN HAS_WON THEN 1 ELSE 0 END) AS NB_BETS_WON
FROM "ROX_DEV"."DBT_JNADAL"."RETRO_CUSTOMER_BET_SELECTION"
GROUP BY USERNAME, CUSTOMER_ID, BET_DATE::DATE
)

, BEST_DAYS AS (
SELECT 
    USERNAME,
    CUSTOMER_ID,
    BET_DATE,
    WINNING_AMOUNT,
    NB_BETS_WON,
    row_number() over (partition by USERNAME order by WINNING_AMOUNT DESC) as row_num
FROM ALL_DAYS
qualify row_num <= 5
)

SELECT 
   USERNAME AS USER_NAME,
   CUSTOMER_ID,
   MAX(CASE WHEN ROW_NUM = 1 THEN WINNING_AMOUNT ELSE NULL END)::NUMBER(38,0) AS BEST_DAY_WIN_AMOUNT_1 ,
   MAX(CASE WHEN ROW_NUM = 2 THEN WINNING_AMOUNT ELSE NULL END)::NUMBER(38,0) AS BEST_DAY_WIN_AMOUNT_2 ,
   MAX(CASE WHEN ROW_NUM = 3 THEN WINNING_AMOUNT ELSE NULL END)::NUMBER(38,0) AS BEST_DAY_WIN_AMOUNT_3 ,
   MAX(CASE WHEN ROW_NUM = 4 THEN WINNING_AMOUNT ELSE NULL END)::NUMBER(38,0) AS BEST_DAY_WIN_AMOUNT_4 ,
   MAX(CASE WHEN ROW_NUM = 5 THEN WINNING_AMOUNT ELSE NULL END)::NUMBER(38,0) AS BEST_DAY_WIN_AMOUNT_5 ,
   
   MAX(CASE WHEN ROW_NUM = 1 THEN BET_DATE ELSE NULL END) AS BEST_DAY_DATE_1 ,
   MAX(CASE WHEN ROW_NUM = 2 THEN BET_DATE ELSE NULL END) AS BEST_DAY_DATE_2 ,
   MAX(CASE WHEN ROW_NUM = 3 THEN BET_DATE ELSE NULL END) AS BEST_DAY_DATE_3 ,
   MAX(CASE WHEN ROW_NUM = 4 THEN BET_DATE ELSE NULL END) AS BEST_DAY_DATE_4 ,
   MAX(CASE WHEN ROW_NUM = 5 THEN BET_DATE ELSE NULL END) AS BEST_DAY_DATE_5 ,

   MAX(CASE WHEN ROW_NUM = 1 THEN NB_BETS_WON ELSE NULL END) AS BEST_DAY_NB_BET_1 ,
   MAX(CASE WHEN ROW_NUM = 2 THEN NB_BETS_WON ELSE NULL END) AS BEST_DAY_NB_BET_2 ,
   MAX(CASE WHEN ROW_NUM = 3 THEN NB_BETS_WON ELSE NULL END) AS BEST_DAY_NB_BET_3 ,
   MAX(CASE WHEN ROW_NUM = 4 THEN NB_BETS_WON ELSE NULL END) AS BEST_DAY_NB_BET_4 ,
   MAX(CASE WHEN ROW_NUM = 5 THEN NB_BETS_WON ELSE NULL END) AS BEST_DAY_NB_BET_5 
FROM BEST_DAYS
GROUP BY 1, 2







 
 
 
 
 

 
 
 
 
 